# Public site (set LRCOM_DOMAIN in your .env). The default keeps the file
# parseable if the env var is missing.
#
# Force HTTP -> HTTPS redirect.
http://{$LRCOM_DOMAIN:localhost} {
  redir https://{host}{uri} permanent
}

# HTTPS site (adds HSTS).
https://{$LRCOM_DOMAIN:localhost} {
  # Disable all access logs (no connection tracking, no IPs logged)
  log {
    output discard
  }

  # Request RSA 4096-bit certs from Let's Encrypt (instead of ECDSA).
  tls {
    key_type rsa4096
  }


  route {
    # HSTS: after the first successful HTTPS response, browsers will automatically
    # upgrade future navigations to HTTPS.
    # NOTE: This is sticky in browsers; keep it enabled only when you're sure HTTPS is correct.
    header Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Cache static files copied from client/public/ (these end up at the site root).
    # Note: service worker updates can get sticky if cached; keep sw.js no-cache.
    @service_worker {
      path /sw.js
    }
    header @service_worker Cache-Control "no-cache"

    @public_static {
      path \
        /apple-touch-icon.png \
        /calling.wav \
        /call_interrupted.wav \
        /favicon-96x96.png \
        /favicon.ico \
        /favicon.svg \
        /icons.svg \
        /incoming_call.wav \
        /incoming_message.wav \
        /lrcom_logo.png \
        /site.webmanifest \
        /web-app-manifest-192x192.png \
        /web-app-manifest-512x512.png
    }
    header @public_static Cache-Control "private, max-age=3600"

    # Per-endpoint rate limiting (requires Caddy built with github.com/mholt/caddy-ratelimit)
    # Keyed by client IP.
    rate_limit {
      zone api_global {
        match {
          path /api/*
        }
        key    {remote_host}
        events 1200
        window 1m
      }

      zone turn_unauth {
        match {
          path /turn
          method GET
        }
        key    {remote_host}
        events 60
        window 1m
      }

      zone auth_login {
        match {
          path /api/auth/login /api/auth/login-init /api/auth/login-final
          method POST
        }
        key    {remote_host}
        events 20
        window 1m
      }

      zone auth_register {
        match {
          path /api/auth/register
          method POST
        }
        key    {remote_host}
        events 20
        window 1m
      }

      zone auth_check_username {
        match {
          path /api/auth/check-username
          method POST
        }
        key    {remote_host}
        events 60
        window 1m
      }

      zone signed_presence {
        match {
          path /api/signed/presence
          method POST
        }
        key    {remote_host}
        events 150
        window 1m
      }

      zone signed_message_send {
        match {
          path /api/signed/messages/send
          method POST
        }
        key    {remote_host}
        events 120
        window 1m
      }

      zone signed_message_update {
        match {
          path /api/signed/messages/update
          method POST
        }
        key    {remote_host}
        events 120
        window 1m
      }

      zone signed_message_delete {
        match {
          path /api/signed/messages/delete
          method POST
        }
        key    {remote_host}
        events 120
        window 1m
      }

      zone signed_create_chat {
        match {
          path /api/signed/chats/create-personal /api/signed/chats/create-group
          method POST
        }
        key    {remote_host}
        events 20
        window 1m
      }

      zone signed_group_admin {
        match {
          path /api/signed/chats/add-member /api/signed/chats/rename-group
          method POST
        }
        key    {remote_host}
        events 30
        window 1m
      }

      zone signed_account_delete {
        match {
          path /api/signed/account/delete
          method POST
        }
        key    {remote_host}
        events 20
        window 1m
      }

      zone signed_account_update {
        match {
          path /api/signed/account/update
          method POST
        }
        key    {remote_host}
        events 120
        window 1m
      }

      zone signed_session_refresh {
        match {
          path /api/signed/session/refresh
          method POST
        }
        key    {remote_host}
        events 3
        window 1m
      }
    }

    # Proxy everything (HTTP + WebSocket) to the app running HTTPS inside the network.
    reverse_proxy https://lrcom:8443 {
      transport http {
        # The app uses an internal/self-signed cert by default.
        tls_insecure_skip_verify
      }
    }
  }
}
